stages:
  - test

# This workflow rule prevents duplicate pipelines when pushing to branches that
# already have a merge request open. Our integration branch "develop" is an
# explicit exception and shall always trigger.
#
# The rules are applied in order, the first matching one decides.
#
# Compare https://docs.gitlab.com/ee/ci/yaml/#rules
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH


test-vm-connection:
  stage: test
  script:
    - apt-get update && apt-get --assume-yes --verbose-versions --no-install-recommends install curl
    # Check availability of VM from pipeline
    - curl http://10.200.116.16/univention/portal/

e2e-test:
  image: tiangolo/docker-with-compose:latest
  services:
    - docker:dind
  before_script:
    - docker version
    - docker compose version
    - cd docker
    - docker compose build portal-frontend portal-server notifications-api reverse-proxy db
  script:
    - docker compose up portal-frontend portal-server notifications-api reverse-proxy db
    - sleep 60
  after_script:
    - docker compose down
