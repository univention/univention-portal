---

variables:
  SOUVAP_API_V4_URL: https://gitlab.souvap-univention.de/api/v4
  SOUVAP_DOCKER_ACCESS_USER: gitlab-ci-knut
  SOUVAP_HELM_ACCESS_USER: gitlab-ci-knut
  SOUVAP_HELM_PROJECT_ID: 75
  SOUVAP_REGISTRY_HOST: registry.souvap-univention.de
  SOUVAP_REGISTRY_PATH: souvap/tooling/images/univention-portal
  SOUVAP_REGISTRY_REPO: ${SOUVAP_REGISTRY_HOST}/${SOUVAP_REGISTRY_PATH}


include:
  - project: univention/customers/dataport/upx/common-ci
    file:
      - defaults/souvap-workflow.yaml
      - jobs/lint-commit-messages.yaml
      - jobs/lint-pre-commit.yaml
      - jobs/package-and-publish-helm-charts.yaml


stages:
  - lint
  - prepare
  - build
  - test
  - trigger
  - package
  - publish


lint-pre-commit:
  before_script:
    # Compose lint would fail without the referenced env files
    - cp docker/.env.example docker/.env
    - cp docker/.env.listener.example docker/.env.listener
    # Helm chart liniting needs the dependency charts present
    # 829 is the project ID of common-helm
    - helm repo add --username gitlab-ci-token --password ${CI_JOB_TOKEN} common-helm ${CI_API_V4_URL}/projects/829/packages/helm/stable
    - |
      for helm_path in `find ./helm -mindepth 1 -maxdepth 1 -type d`; do
        helm dependency update $helm_path
      done


trigger-notifications-api:
  stage: trigger
  needs: []
  trigger:
    strategy: depend
    include:
      - local: 'notifications-api/.gitlab-ci.yml'
  rules:
    - changes:
        - 'notifications-api/**/*'
        - 'tests/**/*'


trigger-frontend:
  stage: trigger
  needs: []
  trigger:
    strategy: depend
    include:
      - local: 'frontend/.gitlab-ci.yml'
  rules:
    - changes: &portal-frontend-changes
        - 'frontend/**/*'
        - 'tests/**/*'


trigger-portal-server:
  stage: trigger
  needs: []
  trigger:
    strategy: depend
    include:
      - local: 'portal-server/.gitlab-ci.yml'
  rules:
    - changes: &portal-server-changes
        - 'docker/portal-server/**/*'
        - 'listener/**/*'
        - 'portal-server/**/*'
        - 'python/**/*'
        - 'setup.py'
        - 'tests/**/*'
        - 'udm/**/*'
        - 'unittests/**/*'
        - 'univention-portal'
        - 'univention-portal-server'


# TODO: Pending removal. This can be removed once the ucs-machine (VMs) are not
# used anymore. Usage in the dev environment and in the SouvAP deployment.
trigger-debian-package:
  stage: trigger
  needs: []
  trigger:
    strategy: depend
    include:
      - local: '.gitlab-ci.debian.yml'
  rules:
    - changes: *portal-server-changes
    - changes: *portal-frontend-changes
    - changes:
        - 'debian/**/*'


package-helm-charts:
  before_script:
    # 829 is the project ID of common-helm
    - helm repo add --username gitlab-ci-token --password ${CI_JOB_TOKEN} common-helm ${CI_API_V4_URL}/projects/829/packages/helm/stable


publish-helm-charts:
  needs: null
  when: always

...
