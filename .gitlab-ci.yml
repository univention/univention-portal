---

variables:
  SOUVAP_API_V4_URL: https://gitlab.souvap-univention.de/api/v4
  SOUVAP_DOCKER_ACCESS_USER: gitlab-ci-knut
  SOUVAP_HELM_ACCESS_USER: gitlab-ci-knut
  SOUVAP_HELM_PROJECT_ID: 75
  SOUVAP_REGISTRY_HOST: registry.souvap-univention.de
  SOUVAP_REGISTRY_PATH: souvap/tooling/images/univention-portal
  SOUVAP_REGISTRY_REPO: ${SOUVAP_REGISTRY_HOST}/${SOUVAP_REGISTRY_PATH}


include:
  - project: univention/customers/dataport/upx/common-ci
    file:
      - defaults/stages.yaml
      - defaults/souvap-workflow.yaml
      - templates/souvap.yaml
      - jobs/lint-commit-messages.yaml
      - jobs/lint-pre-commit.yaml
      - jobs/package-and-publish-helm-charts.yaml


lint-pre-commit:
  before_script:
    # Compose lint would fail without the referenced env files
    - cp docker/.env.example docker/.env
    - cp docker/.env.listener.example docker/.env.listener
    - helm repo add bitnami https://charts.bitnami.com/bitnami


trigger-notifications-api:
  stage: trigger
  needs: []
  trigger:
    strategy: depend
    include:
      - local: 'notifications-api/.gitlab-ci.yml'
  rules:
    - changes:
        - 'notifications-api/**/*'
        - 'tests/**/*'


trigger-frontend:
  stage: trigger
  needs: []
  trigger:
    strategy: depend
    include:
      - local: 'frontend/.gitlab-ci.yml'
  rules:
    - changes: &portal-frontend-changes
        - 'frontend/**/*'
        - 'tests/**/*'


trigger-portal-server:
  stage: trigger
  needs: []
  trigger:
    strategy: depend
    include:
      - local: 'portal-server/.gitlab-ci.yml'
  rules:
    - changes: &portal-server-changes
        - 'docker/portal-server/**/*'
        - 'listener/**/*'
        - 'portal-server/**/*'
        - 'python/**/*'
        - 'setup.py'
        - 'tests/**/*'
        - 'udm/**/*'
        - 'unittests/**/*'
        - 'univention-portal'
        - 'univention-portal-server'


# TODO: Pending removal. This can be removed once the ucs-machine (VMs) are not
# used anymore. Usage in the dev environment and in the SouvAP deployment.
trigger-debian-package:
  stage: trigger
  needs: []
  trigger:
    strategy: depend
    include:
      - local: '.gitlab-ci.debian.yml'
  rules:
    - changes: *portal-server-changes
    - changes: *portal-frontend-changes
    - changes:
        - 'debian/**/*'


# TODO: Remove once we drop this job from common-ci
publish-helm-charts:
  rules:
    - when: never


publish-helm-charts-souvap:
  extends: .publish-helm-charts-souvap

...
