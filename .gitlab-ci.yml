include:
  - project: univention/dist/docker-services
    file: kaniko.yml

# TODO: The pre-commit image is missing hadolint, that's why we are building our
# own one here until it is integrated upstream.
#
# Compare: https://git.knut.univention.de/univention/dist/docker-services

build-linter:
  extends: .kaniko
  variables:
    DOCKERFILE_PATH: docker/linter-pre-commit/Dockerfile
    KANIKO_BUILD_CONTEXT: docker/linter-pre-commit/
  rules:
    - if: '$CI_PIPELINE_SOURCE != "merge_request_event"'

pre-commit-linting:
  needs:
    - job: build-linter
  image: "$IMAGE_TAG"
  variables:
    PIP_CACHE_DIR: "${CI_PROJECT_DIR}/.cache/pip"
    PRE_COMMIT_HOME: "${CI_PROJECT_DIR}/.cache/pre-commit"
  # TODO: temporarily disabled to investigate an issue
  # cache:
  #   paths:
  #   - "${PIP_CACHE_DIR}"
  #   - "${PRE_COMMIT_HOME}"
  script:
    - pre-commit run --all-files
