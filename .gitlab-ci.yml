stages:
  - test

# This workflow rule prevents duplicate pipelines when pushing to branches that
# already have a merge request open. Our integration branch "develop" is an
# explicit exception and shall always trigger.
#
# The rules are applied in order, the first matching one decides.
#
# Compare https://docs.gitlab.com/ee/ci/yaml/#rules
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH


test-vm-connection:
  stage: test
  script:
    - apt-get update && apt-get --assume-yes --verbose-versions --no-install-recommends install curl
    # Check availability of VM from pipeline
    - curl http://10.200.116.16/univention/portal/
  rules:
    - when: never

test-tross-connection:
  stage: test
  before_script:
    - eval $(ssh-agent -s)
    - echo "${SSH_PRIVATE_KEY_E2E_TESTS}" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan tross.knut.univention.de >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - ssh dchakravorty@tross.knut.univention.de "virsh snapshot-revert dchakravorty_test after_ucs_license_import"

e2e-test:
  image: tiangolo/docker-with-compose:latest
  services:
    - docker:dind
  artifacts:
    when: on_failure
    paths:
      - tests/e2e/test-results/
    expire_in: 1 day
  before_script:
    # The Docker client version is automatically downgraded to 1.39 due to version
    # negotiation.
    - export DOCKER_API_VERSION=1.41
    - docker version
    - docker compose version
    - cd docker
    - docker compose build portal-frontend portal-server notifications-api reverse-proxy db e2e-tests
  script:
    - docker compose up -d portal-frontend portal-server notifications-api reverse-proxy db
    - sleep 60
    - docker compose run --name e2e-ci e2e-tests
  after_script:
    - docker cp e2e-ci:/e2e/test-results/ $CI_PROJECT_DIR/tests/e2e/ || true
    - docker compose down --remove-orphans
  rules:
    - when: never
