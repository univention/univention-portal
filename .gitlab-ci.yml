---

variables:
  SOUVAP_HELM_PROJECT_ID: 155
  SOUVAP_REGISTRY_PATH: souvap/tooling/images/univention


include:
  - project: "univention/customers/dataport/upx/common-ci"
    ref: "v0.5.0"
    file:
      - "defaults/stages.yaml"
      - "defaults/souvap-workflow.yaml"
      - "templates/semantic-release-env.yaml"
      - "templates/souvap.yaml"
      - "jobs/lint-commit-messages.yaml"
      - "jobs/lint-pre-commit.yaml"
      - "jobs/package-and-publish-helm-charts.yaml"


lint-pre-commit:
  before_script:
    # Compose lint would fail without the referenced env files
    - cp docker/.env.example docker/.env
    - cp docker/.env.keycloak.example docker/.env.keycloak
    - cp docker/.env.listener.example docker/.env.listener
    - cp docker/.env.umc-gateway.example docker/.env.umc-gateway
    - cp docker/.env.umc-server.example docker/.env.umc-server
    - helm repo add bitnami https://charts.bitnami.com/bitnami


pre-semantic-release:
  extends: ".pre-semantic-release"


trigger-notifications-api:
  stage: trigger
  needs:
    - job: "pre-semantic-release"
      artifacts: true
  variables:
    RELEASE_VERSION: "${RELEASE_VERSION}"
  trigger:
    strategy: depend
    include:
      - local: 'notifications-api/.gitlab-ci.yml'
  rules:
    - changes:
        - 'notifications-api/**/*'
        - 'tests/**/*'


trigger-frontend:
  stage: trigger
  needs:
    - job: "pre-semantic-release"
      artifacts: true
  variables:
    RELEASE_VERSION: "${RELEASE_VERSION}"
  trigger:
    strategy: depend
    include:
      - local: 'frontend/.gitlab-ci.yml'
  rules:
    - changes: &portal-frontend-changes
        - 'frontend/**/*'
        - 'tests/**/*'


trigger-portal-server:
  stage: trigger
  needs:
    - job: "pre-semantic-release"
      artifacts: true
  variables:
    RELEASE_VERSION: "${RELEASE_VERSION}"
  trigger:
    strategy: depend
    include:
      - local: 'portal-server/.gitlab-ci.yml'
  rules:
    - changes: &portal-server-changes
        - 'docker/portal-server/**/*'
        - 'docker/portal-listener/**/*'
        - 'listener/**/*'
        - 'portal-server/**/*'
        - 'python/**/*'
        - 'setup.py'
        - 'tests/**/*'
        - 'udm/**/*'
        - 'unittests/**/*'
        - 'univention-portal'
        - 'univention-portal-server'


# TODO: Pending removal. This can be removed once the ucs-machine (VMs) are not
# used anymore. Usage in the dev environment and in the SouvAP deployment.
trigger-debian-package:
  stage: trigger
  needs: []
  trigger:
    strategy: depend
    include:
      - local: '.gitlab-ci.debian.yml'
  rules:
    - changes: *portal-server-changes
    - changes: *portal-frontend-changes
    - changes:
        - 'debian/**/*'


package-helm-charts:
  needs:
    - job: "pre-semantic-release"
      artifacts: true


publish-helm-charts-souvap:
  extends: .publish-helm-charts-souvap

...
