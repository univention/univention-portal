stages:
  - build
  - test

build_portal_server:
  stage: build
  image: docker:20.10.10
  
  services:
    - docker:dind

  variables:
    CI_REGISTRY: docker-registry.knut.univention.de

  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER $CI_REGISTRY --password-stdin

  script:
    - docker login $CI_REGISTRY
    - docker build --platform linux/amd64 -t $CI_REGISTRY/portal-server:latest -f images/portal-server/Dockerfile .
    - docker push $CI_REGISTRY/portal-server:latest

  rules:
    - changes:
        - images/portal-server/Dockerfile

build_apache:
  stage: build
  image: docker:20.10.10

  services:
    - docker:dind
  
  variables:
    CI_REGISTRY: docker-registry.knut.univention.de

  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER $CI_REGISTRY --password-stdin

  script:
    - docker login $CI_REGISTRY
    - docker build --platform linux/amd64 -t $CI_REGISTRY/apache:latest -f images/apache/Dockerfile .
    - docker push $CI_REGISTRY/apache:latest

  rules:
    - changes:
        - images/apache/Dockerfile

run_tests:
  stage: test
  image: python:3.7-slim-buster

  variables:
    APT_KEY_URL: "https://updates.software-univention.de/univention-archive-key-ucs-5x.gpg"

  before_script:
    - apt-get update
    - apt-get --assume-yes --no-install-recommends install curl gpg gpg-agent g++ libsasl2-dev python3-dev libldap2-dev
    - curl -fsSL "${APT_KEY_URL}" | apt-key add -
    - cp ./sources.list /etc/apt/sources.list.d/15_ucs-online-version.list
    - apt-get update
    - apt-get --assume-yes --no-install-recommends install univention-unittests
    - apt-get clean
    - pip install pytest
    - pip install pytest-mock
    - mkdir -p /var/log/univention && touch /var/log/univention/portal.log
    - cp -r /usr/lib/python3/dist-packages/univentionunittests/ /usr/local/lib/python3.7/site-packages/

  script:
    - pip install -r requirements.txt
    - pip install .
    - cd unittests
    - python -m pytest

  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_REF_NAME == 'master'