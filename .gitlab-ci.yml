include:
  - project: univention/dist/docker-services
    file: kaniko.yml


build-portal-frontend-test-runner:
  stage: build
  extends: .kaniko
  variables:
    KANIKO_BUILD_CONTEXT: "frontend"
    CI_REGISTRY_IMAGE: "$CI_REGISTRY_IMAGE/portal-frontend"
    KANIKO_ARGS: "--target=test --cache=true"


build-portal-frontend:
  stage: build
  extends: .kaniko
  needs:
      - build-portal-frontend-test-runner
  variables:
    KANIKO_BUILD_CONTEXT: "frontend"
    CI_REGISTRY_IMAGE: "$CI_REGISTRY_IMAGE/portal-frontend"
    KANIKO_ARGS: "--cache=true"


test-portal-frontend-unit:
  stage: test
  needs:
    - job: build-portal-frontend-test-runner
  image: "$IMAGE_TAG"
  script:
    - yarn --cwd=/app test:unit


lint-portal-frontend:
  stage: test
  needs:
    - job: build-portal-frontend-test-runner
  image: "$IMAGE_TAG"
  script:
    - yarn --cwd=/app lint



test-portal-frontend-e2e:
  stage: test
  needs:
    - job: build-portal-frontend-test-runner
  image: "$IMAGE_TAG"
  artifacts:
    when: always
    paths:
      - app/tests/e2e/videos/**/*.mp4
      - app/tests/e2e/screenshots/**/*.png
    expire_in: 1 day
  script:
    - yarn --cwd=/app test:e2e:headless --browser chrome