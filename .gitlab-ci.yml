---

variables:
  SOUVAP_HELM_PROJECT_ID: 75
  SOUVAP_REGISTRY_PATH: souvap/tooling/images/univention-portal


include:
  - project: univention/customers/dataport/upx/common-ci
    ref: dchakravorty/issue-732-e2e-test-scheduled-pipeline
    file:
      - defaults/stages.yaml
      - defaults/souvap-workflow.yaml
      - templates/souvap.yaml
      - jobs/lint-commit-messages.yaml
      - jobs/lint-pre-commit.yaml
      - jobs/package-and-publish-helm-charts.yaml


lint-pre-commit:
  before_script:
    # Compose lint would fail without the referenced env files
    - cp docker/.env.example docker/.env
    - cp docker/.env.keycloak.example docker/.env.keycloak
    - cp docker/.env.listener.example docker/.env.listener
    - cp docker/.env.umc-gateway.example docker/.env.umc-gateway
    - cp docker/.env.umc-server.example docker/.env.umc-server
    - helm repo add bitnami https://charts.bitnami.com/bitnami


trigger-notifications-api:
  stage: trigger
  needs: []
  trigger:
    strategy: depend
    include:
      - local: 'notifications-api/.gitlab-ci.yml'
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULE_NAME == "e2e"
      when: never
    - changes:
        - 'notifications-api/**/*'
        - 'tests/**/*'


trigger-frontend:
  stage: trigger
  needs: []
  trigger:
    strategy: depend
    include:
      - local: 'frontend/.gitlab-ci.yml'
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULE_NAME == "e2e"
      when: never
    - changes: &portal-frontend-changes
        - 'frontend/**/*'
        - 'tests/**/*'


trigger-portal-server:
  stage: trigger
  needs: []
  trigger:
    strategy: depend
    include:
      - local: 'portal-server/.gitlab-ci.yml'
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULE_NAME == "e2e"
      when: never
    - changes: &portal-server-changes
        - 'docker/portal-server/**/*'
        - 'listener/**/*'
        - 'portal-server/**/*'
        - 'python/**/*'
        - 'setup.py'
        - 'tests/**/*'
        - 'udm/**/*'
        - 'unittests/**/*'
        - 'univention-portal'
        - 'univention-portal-server'


# TODO: Pending removal. This can be removed once the ucs-machine (VMs) are not
# used anymore. Usage in the dev environment and in the SouvAP deployment.
trigger-debian-package:
  stage: trigger
  needs: []
  trigger:
    strategy: depend
    include:
      - local: '.gitlab-ci.debian.yml'
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULE_NAME == "e2e"
      when: never
    - changes: *portal-server-changes
    - changes: *portal-frontend-changes
    - changes:
        - 'debian/**/*'


# TODO: Remove once we drop this job from common-ci
publish-helm-charts:
  rules:
    - when: never


publish-helm-charts-souvap:
  extends: .publish-helm-charts-souvap
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULE_NAME == "e2e"
      when: never
    - when: on_success


e2e-tests:
  stage: trigger
  needs: []
  trigger:
    strategy: depend
    include:
      - local: 'tests/.gitlab-ci.yml'
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULE_NAME == "e2e"

...
