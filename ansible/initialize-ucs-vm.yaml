- name: Initialize UCS VM for development
  hosts: jbornhold_clean
  # We don't have any users yet
  remote_user: root

  tasks:
    - name: Set authorized key for root user
      ansible.posix.authorized_key:
        user: root
        state: present
        key: "{{ ssh_key }}"

    - name: Flush nscd cache
      # Avoid outdated information in the passwd database.
      # Compare /etc/nscd.conf on your box.
      ansible.builtin.command: nscd -i passwd

    - name: Check if user "user" exists
      ansible.builtin.getent:
        database: passwd
        key: user
        fail_key: False

    - ansible.builtin.debug:
        var: ansible_facts.getent_passwd

    # TODO: Ensure user is in group Domain Admins
    - name: Ensure user "user" exists
      # Setting the password will fail if the user does already exist and the
      # value is unchanged
      when: not ansible_facts.getent_passwd.user
      block:
        - name: Create user "user" in directory via udm
          # when: False
          univention.ucs_modules.univention_directory_manager:
            module: users/user
            state: present
            set_properties:
              - property: username
                value: user
              - property: lastname
                value: User
              - property: password
                value: univention

        - name: Flush nscd cache
          ansible.builtin.command: nscd -i passwd

        - name: Trigger home directory creation
          ansible.builtin.command:
            cmd: sudo -u user /bin/true
            creates: /home/user

    - name: Set authorized key for user "user"
      ansible.posix.authorized_key:
        user: user
        state: present
        key: "{{ ssh_key }}"

    - name: Add Gitlab to known hosts
      ansible.builtin.known_hosts:
        name: git.knut.univention.de
        path: /etc/ssh/ssh_known_hosts
        key: "{{ lookup('ansible.builtin.file', 'pubkeys/git.knut.univention.de') }}"

    - name: Ensure that git is installed
      ansible.builtin.apt:
        name: git
