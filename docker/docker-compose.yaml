version: '3.3'

services:
  portal-frontend:
    build:
      context: ../frontend
    container_name: univention-portal-frontend
    ports:
      - "8080:80"
  portal-server:
    platform: "linux/amd64"
    build:
      context: ../
      dockerfile: docker/portal-server/Dockerfile
    container_name: univention-portal-server
    env_file: .env.portal-server
    ports:
      - "8095:80"
    volumes:
      # TODO: The config files are dynamic, currently using stub files so that
      # it is easy to run the univention-portal-server for local inspection.
      - type: bind
        source: ./portal-server/stub_config.json
        target: /usr/lib/univention-portal/config/config.json
      - type: bind
        source: ./portal-server/stub_groups.json
        target: /var/cache/univention-portal/groups.json
      - type: bind
        source: ./portal-server/stub_portal.json
        target: /var/cache/univention-portal/portal.json
  test:
    profiles:
      - test
    platform: "linux/amd64"
    build:
      context: ../
      dockerfile: docker/portal-server/Dockerfile
      target: test
    container_name: univention-portal-server-test
    environment:
      # TODO: "dist-packages" part required due to custom interpreter
      PYTHONPATH: "./python:/usr/lib/python3/dist-packages"
    volumes:
      - type: bind
        source: ../python
        target: /staging/python
      - type: bind
        source: ../unittests
        target: /staging/unittests

  pre-commit:
    profiles:
      - test
    platform: "linux/amd64"
    build:
      context: linter-pre-commit
    container_name: univention-portal-pre-commit
    environment:
      PIP_CACHE_DIR: /cache/pip
      PRE_COMMIT_HOME: /cache/pre-commit
    working_dir: /work
    volumes:
      - type: bind
        source: ..
        target: /work
      - type: volume
        # pre-commit installs dependencies, having them cached speeds things up
        # a lot.
        source: pre-commit-cache
        target: /cache

volumes:
  pre-commit-cache:
