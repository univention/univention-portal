#!/usr/bin/python3

import os
import os.path
import fileinput

portal_path = "/usr/share/univention-portal"

for line in fileinput.input([]):
    line = line.strip()
    key, old, new = line.split("@%@", 2)
    if key != "portal/paths":
        continue
    old = old.split(",")
    new = new.split(",")
    for path in old:
        if path in new:
            continue
        path = os.path.normpath("/var/www" + path.strip())
        if not os.path.islink(path) or os.path.realpath(path) != portal_path:
            print(f"{path} does not link to the portal contents. Skipping...")
        else:
            print(f"Removing portal link to {path}...")
            os.unlink(path)
    for path in new:
        if path in old:
            continue
        path = os.path.normpath("/var/www" + path.strip())
        if os.path.islink(path):
            link_target = os.path.realpath(path)
            print(f"{path} already links (to {link_target}). Skipping...")
        else:
            print(f"Linking {path} to portal content...")
            os.symlink(portal_path, path)
